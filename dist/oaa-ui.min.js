!function(){"use strict";angular.module("oaa.ui",["highcharts-ng"])}(),angular.module("oaa.ui").directive("flag",["countryService",function(t){return{restrict:"E",scope:{country:"=",size:"=",flagOnly:"="},templateUrl:"app/oaa/ui/flags/flagDirective.html",link:function(e,a,n){e.loading=1,e.getFlagClasses=function(){var t="display:none;";try{t="flag-icon-background flag-icon-"+e.country.GlyphIconFlagCode.toLowerCase()}catch(t){}return t},e.getFlagDimensions=function(){return{width:e.width+"px",height:e.height+"px"}},function(){switch(e.size){case"small":e.height=75,e.width=100;break;case"medium":e.height=112,e.width=150;break;case"large":e.height=150,e.width=200;break;default:e.height=75,e.width=100}e.country&&!e.country.Title&&(e.loading++,t.getByFilter("Title eq '"+e.country+"'").then(function(t){e.country=t[0],e.loading--})),e.loading--}()}}}]),angular.module("oaa.ui").directive("oaaTimeline",["moment","_","prioritiesService","oaaTypesService","$uibModal","$timeout",function(t,e,a,n,i,o){return{restrict:"E",scope:{oaaList:"=",fyStart:"=",fyEnd:"=",showLegend:"=",sortBy:"=",sortByFilter:"="},templateUrl:"app/oaa/ui/timeline/oaaTimeline.html",link:{pre:function(o,r,s){function l(){Highcharts.theme={chart:{backgroundColor:"#FFFFFF"},title:{style:{color:"gray"}},subtitle:{style:{color:"gray"}},legend:{itemStyle:{font:'11pt "Calibri", Verdana, sans-serif',color:"#333"},itemHoverStyle:{color:"gray"}}},Highcharts.setOptions(Highcharts.theme)}function d(t,e,a){switch(t){case"view-staffing":window.open("#/staffingTool/oaa/"+e.Id,"_blank");break;case"view-checklist":c(e);break;case"view-oaa":window.open("#/eventDetails/"+e.Event_x003a_OAA_x0020_Type.split(";#")[0]+"/"+e.Id,"_blank");break;case"view-documents":u(e)}return a.preventDefault(),!1}function c(t){i.open({templateUrl:"StaffingTool/CheckListItemModal/checkListItemModal.html",controller:"StaffingCheckListModalCtrl",resolve:{staffingItem:{oaaID:t.ID}}})}function u(t){i.open({windowClass:"wide-modal",controller:"missionProductsModalController",templateUrl:"MissionProducts/missionProductsModal/missionProductsModal.html",resolve:{arrayOfOaaIds:function(){return[t.ID]},arrayOfMissionProducts:null}})}function f(t,a){void 0==e.findWhere(o.legend,{name:t})&&o.legend.push({name:t,color:a})}function h(){for(var t=p().yAxis[0].options.plotLines,e=t.length;e>0;e--)try{p().yAxis[0].removePlotLine(t[0].id)}catch(t){console.log("clearPlotLines() exception")}}function g(){for(var t=p().yAxis[0].options.plotBands,e=t.length;e>0;e--)try{p().yAxis[0].removePlotBand(t[0].id)}catch(t){console.log("clearPlotBands() exception")}}function y(e){for(var a=function(a,n){for(var i=a.data[0].x,o=a.data[1].x,r=e.length,s=0;s<r;s++){var l=e[s];if(a==l)return!1;if(l.data[0]&&l.data[1]&&l.data[0].y==n){if(t(l.data[0].x).isBetween(t(i),t(o)))return!0;if(t(l.data[1].x).isBetween(t(i),t(o)))return!0;if(t(i).isBetween(t(l.data[0].x),t(l.data[1].x)))return!0;if(t(o).isBetween(t(l.data[0].x),t(l.data[1].x)))return!0;if(Math.abs(t(l.data[0].x).diff(t(i),"days"))<5)return!0;if(Math.abs(t(l.data[1].x).diff(t(i),"days"))<5)return!0;if(Math.abs(t(l.data[0].x).diff(t(o),"days"))<5)return!0;if(Math.abs(t(l.data[1].x).diff(t(o),"days"))<5)return!0;if(l.data[0].starts_outside&&a.data[0].starts_outside)return!0;if(l.data[0].ends_outside&&a.data[0].ends_outside)return!0}}return!1},n=function(t,a){for(var n=0;n<e.length;n++){var i=e[n];if(i.data[0].y==a&&i.data[0].group_name!=t)return!1}return!0},i=0,o=0;o<e.length;o++){var r=e[o],s=function(t){for(var i=(t.data[0].x,t.data[1].x,0);i<e.length;i++)if(i>=1&&n(t.data[0].group_name,i)&&!a(t,i))return i;return t.data[0].y+1}(r);s>i&&(i=s),k(r,s)}return e}function p(){return Highcharts.charts&&0!=Highcharts.charts.length||console.log("Highcharts didn't load."),Highcharts.charts[Highcharts.charts.length-1]}function m(t){var a=t.Event_x003a_OAA_x0020_Type.split(";#")[1],n="#808080",i=e.findWhere(o.oaaTypes,{Title:a});return void 0==i?a="Obsolete OAA Type":(a=i.Enumerated,i.OAATypeCategory&&(n=i.OAATypeCategory.Color,a=i.OAATypeCategory.Title),null!=i.color&&""!=i.color&&(n=i.color,a=i.Enumerated)),n&&void 0!=n||(n="#808080"),{name:a,color:n}}function v(a,n){var i=[];return o.oaas=e.reject(o.oaas,function(e){var i=t(e.Start_x0020_Date),o=t(e.End_x0020_Date);return t(o).isBefore(a)||t(i).isAfter(n)}),e.each(o.oaas,function(r,s){if(void 0!==r){var l=r.Event_x003a_OAA_x0020_Type.split(";#")[1]||"UNK",d=t(r.Start_x0020_Date),c=t(r.End_x0020_Date),u=t(c).isBefore(a)||t(d).isAfter(n),h=(t(c).diff(t(d),"days"),d.isBefore(a)?a:d),g=c.isAfter(n)?n:c,y=t(g).diff(t(h),"days");y<17&&(t(h).isSame(t(a),"day")?y=5:t(g).isSame(t(n),"day")?y=5:(h=t(h).add(-(17-y)/2,"days"),g=t(g).add((17-y)/2,"days"),y=17));var p=h==a,v=g==n,b=m(r),A=t(h).add(y/2,"days"),w=r.Priority,_=r.Event_x003a_OAA_x0020_Type.split(";#")[0],T=b.color,k=r.Status?"status-"+r.Status.toLowerCase():"status-none",I=(r.Index,'<span title="'+r.EventID+'" class="data-label" style="color:'+x(T)+'" style="cursor:pointer;">&nbsp;'+l.substring(0,5)+"</span>"),C=r.Group||"",O=void 0!=e.findWhere(o.legend,{name:b.name}),L={name:r.EventID,color:T,className:k,showInLegend:!O,typeName:b.name,data:[{x:h,y:s,index:s,from:d,to:c,priority:w,eventId:_,oaaId:r.Id,starts_outside:p,ends_outside:v,group_name:C},{x:g,y:s,index:s,from:d,to:c,priority:w},{x:A,y:s,label:y<17?"":""+I,index:s,from:d,to:c,priority:w}]};u?o.oaas.splice(s,1):(f(b.name,T),i.push(L))}}),i}function x(t){var e=b(t);return null==e?"#000000":.2126*e.r+.7152*e.g+.0722*e.b>179?"#000000":"#FFFFFF"}function b(t){var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}function A(){var e=p().yAxis[0],a=o.chart.series;g(),h(),I=[];for(var n=a.length,i=0;i<a.length;i++){var r=a[i];T(r.data[0].y,r.data[0].group_name)}n=I.length;for(var i=0;i<n;i++){var s=I[i].highest,l=I[i].lowest;if(n>i+1){var d=I[i+1].lowest,c=s+(d-s)/2;e.addPlotLine({id:c+"_"+t(),color:"gray",width:1,value:c,zIndex:4})}e.addPlotBand({id:I[i].label+"_"+t(),color:"",from:l-1,to:s+1,label:{text:"country"==o.sortBy?'<div class="plotband-label"><span><a href="#/country/'+I[i].label+'/engagements">'+I[i].label+"</a></span></div>":'<div class="plotband-label"><span>'+I[i].label+"</span></div>",align:"left",useHTML:!0}})}}function w(){window.print()}function _(){o.legend=[];var e=o.fyStart,a=o.fyEnd,n=v(e,a);o.oaas=o.oaas.reverse();var i=y(n);o.chart.series=i,p().xAxis[0].setExtremes(e,a,!0,!0),p().xAxis[1].setExtremes(e,a,!0,!0),o.oaas.length>0&&p().xAxis[0].addPlotLine({id:"today",color:"red",width:1,value:t()}),setTimeout(function(){var t=p().yAxis[0].getExtremes(),e=20*t.dataMax*2;e=e<500?500:e,p().setSize(null,e),A(),p().hideLoading()},1e3)}function T(t,a){var n=e.findWhere(I,{label:a});n?(t>=n.highest&&(n.highest=t),t<=n.lowest&&(n.lowest=t)):I.push({highest:t,lowest:t,label:a})}function k(t,e){t.data[0].y=e,t.data[1].y=e,t.data[2].y=e}var I=[];o.print=w,o.$watch("oaaList",function(t,e){o.oaas=t,_()},!1),o.truncated=!0,o.doActionForOaa=d,o.chart={series:[],title:"Chart",alignTicks:!1,navigation:{buttonOptions:{theme:{style:{color:"#039",textDecoration:"underline"}}}},events:{load:function(t){this.showLoading()}},loading:{labelStyle:{top:"45%",display:"block",backgroundColor:"#ddd"}},options:{xAxis:[{type:"datetime",labels:{style:{color:"gray"}},minPadding:0,maxPadding:0},{type:"datetime",title:{},labels:{style:{color:"gray"},formatter:function(){var t=new Date(this.value);return"Q"+(Math.floor((t.getMonth()+3)/3)%4+1)},x:150},tickInterval:7776e6,opposite:!0,gridLineWidth:1}],yAxis:[{plotBands:[],plotLines:[],visible:!1,title:{text:""},labels:{enabled:!1},tickColor:"gray",tickWidth:1,tickLength:20,gridLineWidth:0,minPadding:.1,maxPadding:.05,offset:0},{title:{text:""},opposite:!0,lineWidth:1}],legend:{labelFormatter:function(){return this.userOptions.typeName}},tooltip:{enabled:!1},plotOptions:{column:{stacking:"percent",dataLabels:{enabled:!1}},point:{},line:{lineWidth:20,linecap:"square",stacking:null,getExtremesFromAll:!0,cursor:"pointer",marker:{enabled:!1,states:{hover:{enabled:!1}}},dataLabels:{enabled:!0,align:"center",verticalAlign:"middle",useHTML:!0,formatter:function(){return this.point.options&&this.point.options.label}},events:{legendItemClick:function(){return!1},click:function(){window.open("/OAA/app/Index.html#/eventDetails/"+this.data[0].eventId+"/"+this.data[0].oaaId,"_blank")}}}},series:{pointPadding:2,groupPadding:2,pointWidth:2}}},function(){o.legend=[],o.oaaTypes=[],o.yearFilter=t(o.fyEnd).year()||t().year(),void 0===o.sortBy&&(o.sortBy="priority"),a.get().then(function(t){o.priorities=t}),l(),n.executeRestQuery(null,"*,OAATypeCategory/Id,OAATypeCategory/Title,OAATypeCategory/Color,OAATypeCategory/SortOrder",null,"OAATypeCategory").then(function(t){o.oaaTypes=t,_()})}()}}}}]);